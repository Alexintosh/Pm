## 1. 动机 (Motivation)

数字货币挖矿行业创建了一个巨大的市场。投资挖矿需要投入一笔资金用于购买矿机，并在未来一段时间持续获得挖出的数字币作为投资收益。然而，投资挖矿的风险很大。除去矿场基建、电力资源建设等固定因素及来自政策、天气等等的不可抗因素外，挖矿产业的核心风险来自于数字货币币价的波动和挖矿难度的波动。

由于有大量的金融工具可以对冲币价带来的风险，所以本文不再讨论币价波动带来的风险而主要讨论挖矿难度波动带来的风险。

单位时间内挖矿产生的数字币总量是固定，当参与挖矿的人越多，全网用于挖矿的算力就会越高，此时区块链协议为了维护相对固定的出块时间就会自动提高挖矿难度，从而造成单位算力的挖矿产出下降，由此大大降低了挖矿的投资回报比，延长了投资回报周期。

今天挖矿市场的核心痛点之一便是挖矿市场是一个单边市场，矿工只能选择做多或不投资，即要么投资矿机进行挖矿要么不进行投资，而没有做空的手段。单边市场带来的问题非常明显，矿工往往在币价上涨时扎堆盲目投资矿机进行挖矿，从而造成挖矿难度快速上升，收益很快下降。如果再遇到币价大跌则会损失惨重。

本文提出一种挖矿算力收益合约。这一金融衍生品可以双边交易，其市场成交情况很好的揭示了挖矿风险。通过交易这一衍生品，矿工可以有效对冲难度波动带来的挖矿风险，投机者可以通过承担风险获得收益，进而实现了剥离挖矿难度风险，形成更有效的挖矿市场的目的。

## 2. 合约说明书 (Contract Specification)

以下合约基于[Market Protocol智能合约](https://marketprotocol.io)发行。

###  2.1 以太坊算力收益合约 (Synthetic ETH Mining Contract)

#### 指数 (Index）

以太坊算力收益指数（ _EMI_ ，Ethereum Mining Index ）表示从区块高度 _H_ 前 _N_ 个区块内，_Hashrate_（单位Hash/s） 算力挖矿获得ETH的数学期望。_Difficulty<sub>i</sub>_ 表示区块高度 _i_ 的挖矿难度, _Coinbase<sub>i</sub>_ 表示区块高度 _i_ 的挖矿奖励,  _TargetBlockTime_ 表示以太坊预期出块时间。 _EMI_ 由以下公式计算：

<a href="https://www.codecogs.com/eqnedit.php?latex=\dpi{120}&space;\small&space;\mathit{EMI}=\sum_{i=H-N}^{N-1}\frac{\mathit{Hashrate}&space;\cdot&space;\mathit{TargetBlockTime}&space;\cdot&space;Coinbase_i}{\mathit{Difficulty_i}\cdot&space;2^{^{32}}}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\dpi{120}&space;\small&space;\mathit{EMI}=\sum_{i=H-N}^{N-1}\frac{\mathit{Hashrate}&space;\cdot&space;\mathit{TargetBlockTime}&space;\cdot&space;Coinbase_i}{\mathit{Difficulty_i}\cdot&space;2^{^{32}}}" title="\small \mathit{EMI}=\sum_{i=H-N}^{N-1}\frac{\mathit{Hashrate} \cdot \mathit{TargetBlockTime} \cdot Coinbase_i}{\mathit{Difficulty_i}\cdot 2^{^{32}}}" /></a>

当给定区块高度 _H_ 后，公式中只有 _Difficulty<sub>i</sub>_ 和 _Coinbase<sub>i</sub>_  是随区块高度变化的未知量，其他公式中的参数都是常量。又由于 _Coinbase<sub>i</sub>_ 几乎不变化， 所以 _EMI_ 指数通常只与区块的挖矿难度相关。 _EMI_ 设定的参数如下：

参数 | 取值 | 备注
------| -----|-------
_Hashrate_  | 1,000,000,000,000 Hash/s  | |
_N_  | 80640  | 以14天为指数窗口
_Coinbase<sub>i</sub>_  | 2 ETH | 从区块高度7,080,000起，挖矿收益为2ETH
_TargetBlockTime_ | 15 s |  以太坊的预期出块时间

_选择以上参数是为了让指数的整数部分具有3-4个有效数字，从而便于交易员认知市场，加速交易决策_

#### 指数的范围 (Index Cap & Floor)

每份以太坊算力收益合约都会设置指数的有效范围，用 _Cap_ 表示指数上限，用 _Floor_ 表示指数下限。当指数达到上下限的时候会触发合约交割。

#### 指数货币单位 (Index currency)

每指数点对应1ETH

#### 合约大小 (Contract Size)

每份合约1WETH

#### 到期区块高度 (Expiration)

每份以太坊算力收益合约都会设置一个到期时间，到期时间以以太坊区块高度 _H_ 表示，当高度 _H_ 的区块的确认区块数达到 _NComfirm_ 后合约将被交割。为了安全起见，设置 _NComfirm_ = 960，约4小时。

#### 交割 (Settlement)

合约发生交割时，Maket智能合约将会向合约头寸持有人发送WETH。每份合约多头将收到 ( _EMI_ - _Floor_ ) 个WETH，每份合约空头将收到 ( _Cap_ - _EMI_ ) 个 WETH。

#### 保证金 (Margin)

合约发行人向Market Protocol智能合约抵押（ _Cap_ - _Floor_ ) 个WETH以铸造合约头寸代币。合约的头寸是完全抵押的，合约在交割前不需要补充保证金。

#### 头寸代币命名 （Naming Convention for Contract Position Tokens）

EHR-\<Floor\>-\<Cap\>-\<Height\>-[L|S]

- Floor: 指数下限
- Cap: 指数上限
- Height: 交割区块高度
- L: 多头头寸
- S: 空头头寸

例：EHR-100-200-80000-L，指数范围在[100,200]，于区块高度80000交割，合约多头


###  2.2 比特币算力收益合约 (Synthetic BTC Mining Contract)
#### 指数 (Index）

比特币算力收益指数（ _BMI_ ，Bitcoin Hashrate Revenue Index ）表示以区块高度 _H_的挖矿难度，在 _Hashrate_（单位Hash/s） 算力挖矿2016个块获得的BTC数学期望。_Difficulty<sub>i</sub>_ 表示区块高度 _i_ 的挖矿难度, _Coinbase<sub>i</sub>_ 表示区块高度 _i_ 的挖矿奖励,  _TargetBlockTime_ 表示比特币预期出块时间。 _BMI_ 由以下公式计算：

<a href="https://www.codecogs.com/eqnedit.php?latex=\dpi{120}&space;\small&space;\mathit{BHRI}=\frac{\mathit{Hashrate}&space;\cdot&space;\mathit{TargetBlockTime}&space;\cdot&space;Coinbase_i&space;\cdot&space;2016}{\mathit{Difficulty_i}\cdot&space;2^{^{32}}}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\dpi{120}&space;\small&space;\mathit{BHRI}=\frac{\mathit{Hashrate}&space;\cdot&space;\mathit{TargetBlockTime}&space;\cdot&space;Coinbase_i&space;\cdot&space;2016}{\mathit{Difficulty_i}\cdot&space;2^{^{32}}}" title="\small \mathit{BHRI}=\frac{\mathit{Hashrate} \cdot \mathit{TargetBlockTime} \cdot Coinbase_i \cdot 2016}{\mathit{Difficulty_i}\cdot 2^{^{32}}}" /></a>

当给定区块高度 _H_ 后，公式中 _Difficulty<sub>i</sub>_  是随区块高度变化的未知量，且每2016个区块调整一次。公式中 _Coinbase<sub>i</sub>_ 是随区块高度变化的未知量，每21000个区块减半。公式中其他的参数都是常量。由于比特币每2016个区块才调整一次难度，所以 _BMI_ 在2016个区块的难度周期内保持不变，且在2016个区块内只与区块的挖矿难度相关。 _BMI_ 设定的参数如下：

参数 | 取值 | 备注
------| -----|-------
_Hashrate_  | 10 <sup>18</sup> Hash/s  | |
_Coinbase<sub>i</sub>_  | 目前为12.5 BTC | 每21000个区块减半
_TargetBlockTime_ | 600 s | 比特币的预期出块时间

_选择以上参数是为了让指数的整数部分具有3-4个有效数字，从而便于交易员认知市场，加速交易决策_

#### 指数的范围 (Index Cap & Floor)

每份比特币算力收益合约都会设置指数的有效范围，用 _Cap_ 表示指数上限，用 _Floor_ 表示指数下限。当指数达到上下限的时候会触发合约交割。

#### 指数货币单位 (Index Currency)

每指数点对应1BTC

#### 合约大小 (Contract Size)

每份合约1WBTC

#### 到期区块高度 (Expiration)

每份比特币算力收益合约都会设置一个到期时间，到期时间以比特币区块高度 _H_ 表示，当高度 _H_ 的区块的确认区块数达到 _NComfirm_ 后合约将被交割。为了安全起见，设置 _NComfirm_ = 24，约4小时。

#### 交割 (Settlement)

合约发生交割时，Market智能合约将会向合约头寸持有人发送WBTC。每份合约多头将收到 ( _BMI_ - _Floor_ ) 个WBTC，每份合约空头将收到 ( _Cap_ - _BMI_ ) 个 WBTC。

#### 保证金 (Margin)

合约发行人向Market智能合约抵押（ _Cap_ - _Floor_ ) 个WBTC以铸造合约头寸代币。合约的头寸是完全抵押的，合约在交割前不需要补充保证金。

#### 头寸代币命名 （Naming Convention for Contract Position Tokens）

BMI-\<Floor\>-\<Cap\>-\<Height\>-[L|S]

- Floor: 指数下限
- Cap: 指数上限
- Height: 交割区块高度
- L: 多头头寸
- S: 空头头寸

例：BMI-100-200-80000-S，指数范围在[100,200]，于区块高度80000交割，合约空头

## 3. 智能合约栈 (Smart Contract Stack)

基于以太坊上的智能合约实现对算力收益合约的发行、交易、保证金管理、交割等生命期管理。这个过程可以实现信任最小化，降低了交易门槛，为流动提供保障。

### 3.1 合约代币化 (Tokenization Layer)

基于[Market Protocol智能合约](https://marketprotocol.io) 可以方便实现建立算力收益合约的头寸。同时，Market Protocol的合约头寸都是标准的ERC20代币，从而很容易的可以通过链下交易所或链上去中化协议交易这些头寸。

市场上流通的合约头寸代币需要由发行人铸造（mint）。合约发行人通过向Market Protocol智能合约抵押资产铸造头寸代币。发行人在完成代币铸造后，将同时持有合约的多头代币和空头代币，其净头寸为0。因为铸造的多头代币总是等于空头代币，所以称为代币对。此后，如果发行人希望进入合约多头，则可以在市场上将空头代币卖出，以达到持有多头的目标；反之，如果发行人希望进入合约空头，则可以卖出多头代币。

交易员也可以在市场上直接购买合约代币实现持有合约头寸的目的，而不必在Market Protocol智能合约中铸造头寸代币。任何时候，头寸代币持有人只需要在市场上卖出持有的头寸代币就可以实现平仓，从而不必等待合约交割就可以实现头寸盈亏。

由于算力合约的指数具有上下的范围限制，且发行人已经在创建头寸时为指数范围内的合约价值支付了完全的保证金，所以合约头寸是完全抵押的，在指数范围内没有爆仓的风险。由于算力合约会被用于对冲挖矿风险，而挖矿是一个长期的过程，所以必须尽量避免因为指数到达上下限而造成的合约提前交割的情况。为此，设置指数上下限时需要根据历史数据，设置相对宽松的指数范围，以求覆盖指数波动。

虽然合约头寸是完全抵押的，但指数的范围设置，依旧提供了对指数的杠杆作用。即当指数波动时，合约头寸价值的变化率通常会大于指数的变化率。

例1，Carboclan社区在区块链高度568512（2019-03-21）时设置了一个新的比特币挖矿算力合约。此时指数为552。设置算力收益合约的参数如下：
  - 指数上限：600
  - 指数下限：450
  - 到期时间： 区块高度574560 （约2019-05-04）

Alice希望创建0.01个合约代币对，为此她向Market智能合约质押了(600-450)*0.01=1.5WBTC，从而铸造了0.01个合约多头头寸币和0.01个合约空头头寸币。此时，按指数计算的每个合约多头代币价值为552-450=102 WBTC，每个合约空头代币价值为600-552=48 WBTC。

之后，指数下降到550，此时，按指数计算的每个合约多头代币价值为550-450=100 WBTC，每个合约空头代币价值为600-550=50 WBTC。Alice希望进入合约空头，于是她在交易所中挂单出售0.01个合约多头代币。Bob恰好希望进入合约多头，最终Bob向Alice购买了合约多头币，成交价98WBTC。Bob向Alice支付0.98WBTC，Alice向Bob支付0.01个合约多头币。

这里在市场上头寸代币成交价（98WBTC）低于了按指数计算的价格（100WBTC），这是由于人们对到期日指数会进一步下降的预期造成的。另一方面，我们可以看到，指数下降了(552-550)/552=0.36%，但多头头寸按指数计算的价格却下降了(102-100)/102=1.9%，这就是指数下限造成的5.28倍杠杆作用。

当区块高度为574570时，合约到期。又过了12个区块高度，合约进行交割。此时合约指数为525。Market智能合约向多头持有方Bob支付（525-450)*0.01=0.75WBTC, 向空头只有方Alice支付(600-525)*0.01=0.75WBTC。最终Alice的盈亏为：-1.5+0.98+0.75 = 0.23WBTC，Bob的盈亏为: -0.98+0.75=-0.23WBTC。

### 3.2 预言机 (Oracle)

Market Protocol依赖预言机提供指数。预言机是整套系统的相对中心化的部分。

以太坊算力收益合约的预言不依赖链外数据，可以通过智能合约直接获取区块的难度从而计算出指数。其主要挑战是单次合约调用无法访问80640个区块的难度数据，需要通过不断将难度数据记录保存到合约内部的方式实现。

比特币算力收益合约的预言机依赖以太坊链外数据。需要由外部权威机构提供比特币区块难度信息，提交到预言机智能合约实现。好在比特币区块难度信息的变化很缓慢，平均14天变化一次，且这一信息由于记录在比特币区块链上，全世界任何人都可以对这一数据的真实性进行检验。

### 3.3 交易层 (Trading Layer）

因为基于Market Protocol发行的算力收益合约头寸代币背后是完全抵押的合约头寸，且头寸代币符合ERC20规范，所以头寸代币可以通过任何支持ERC20的线下中心化交易所（例如币安、bitstamp等）或链上去中化的智能合约（例如0x，Uniswap等）交易。这一特性，使得交易算力收益合约变得非常简单。并不需要开发新的交易技术或基础设施就可以进行交易。

### 3.4 浮动保证金层 (Variable Margin Layer) 

在3.1中我们已经分析了使用Market Protocol本身存在对指数的杠杆作用。然而，当指数波动较大时，为了防止指数触达上下限而引发合约交割，需要设置较大范围的指数上下限，进而造成抵押保证金上升，并降低整体杠杆率。

在算力收益合约中，对于相对近期的合约（比如30天)，指数波动不大，此时设置的指数上下限范围相对较小，仅仅使用Market Protocol就提供了相对足够的杠杆率。但对于相对远期的算力合约（比如180天），指数波动可能达到100%，此时Market Protocol的完全抵押保证金的方式会造成交易成本过高。

为此，可以在头寸代币基础上，引入一种浮动保证金层。浮动保证金层的特点是，保证金不是完全抵押的，而是按照头寸市场价设置一个保证金比例，保证金只要能覆盖短期内的价格波动。当头寸价格发生变化造成保证金率下降时，可以向保证金不足的交易方发起追加保证金请求（margin call），从而提高保证金以覆盖波动。另一方面，由于指数波动，当浮盈头寸的保证金率超过了必要比例时，超出的保证金可以从保证金账户中取出，使得头寸持有者实现盈利。这种浮动保证金机制降低了保证金要求，提高了交易双方的资金利用率。

已经有一些Defi的协议实现了浮动保证金功能。[dydx protocol](https://dydx.exchange)是其中的代表。dydx平台提供了融币的功能。一方面，出借方将代币A存到智能合约的资金池中，贷方抵押代币B创建保证金账户，并从资金池中贷出代币A。贷出的代币A可以在交易市场上卖出以获得代币B，卖出获得代币B再次作为抵押进入保证金账户，从而又可以贷出更多代币A用于卖出，最终达到了杠杆做空代币A的目的。相反的，出借方将代币B存到智能合约的资金池中，贷方抵押代币A创建保证金账户，并从资金池中贷出代币B。贷出的基础代币B可以在交易市场上买入更多代币A，获得的代币A再次作为抵押进入保证金账户，从而又可以贷出更多代币B用于买入代币A，最终达到了杠杆做多代币A目的。dydx支持最大4倍杠杆。当抵押的代币相对于贷出的代币的价格下降时，会造成保证金不足，如果贷币方不能及时补充抵押物，会引发强行平仓，从而实现浮动保证金的功能。

目前，dydx还不完全支持直接交易Market的头寸代币，还有一些适配工作需要完成，但应该不会是主要障碍。

## 4. 使用场景（Usage  Scenario)

算力收益合约可以用于多种业务场景。

### 4.1 风险揭示（Risk exposure）

投资人在购买矿机开始挖矿前，需要预估投入产出比(ROI)。投资人购买矿机是一次性投入，未来挖矿需要付出的电费也是固定值，即投资挖矿的投入是确定的。影响挖矿产出的因素就是币价和挖矿难度。已经有大量金融产品（期货、期权、永续合约等）可以揭示或对冲币价波动的风险。挖矿收益合约市场向投资人进一步揭示了因难度波动带来的风险敞口。当投资挖矿前，投资人可以观察近期及远期的算力收益合约的成交价，合约的成交价反应了市场对于挖矿收益的真实估计。

例，在2019年5月1日时，BHRI指数为526, 市场中比特币挖矿收益合约的成交价情况如下：

合约头寸代币 | 预计到期日 | 市场价 | 蕴含挖矿收益
------| -----|-----|---
BHR-450-600-574560-L | 19-05-04 |  75 | 525
BHR-450-600-576576-L | 19-05-18 |  65 | 515
BHR-450-600-578592-L | 19-05-31 |  50 | 500
BHR-450-600-580608-L | 19-06-14 |  35 | 485

合约多头代币反应了市场对相应比特币挖矿难度周期内挖矿收益的判断。从成交价看，市场认为同等算力挖矿收益将逐渐下降。用多头成交价加上指数下限就可以得到成交价蕴含的挖矿收益，即市场认为的在合约交割后的2016个区块内，10 <sup>18</sup> Hash/s算力可以挖出的比特币个数。投资人从算力收益合约市场可以发现预期的挖矿收益是逐步下降的，从而对挖矿ROI做出更理性的预估。

### 4.2 对冲风险 (Hedge the risk)

算力收益合约在揭示挖矿风险的基础上，还可以进一步对冲挖矿风险。同样的，这里的讨论忽略币价的波动，因为有大量它衍生品可以对冲币价波动。投资人在购买矿机挖矿的同时，进入算力收益合约空头，对难度引起的挖矿收益波动进行对冲。当挖矿难度上升，挖矿收益下降时，合约空头的利润将抵消真实矿机挖矿收益下降的部分；当挖矿难度下降，挖矿收益上升时，合约空头的亏损将被真实矿机挖矿收益上升的部分抵消。上述对冲操作相对于提前锁定了挖矿收益，锁定的收益为（合约指数上限-进入头寸价格）。

例，Alice在2019年5月1日，购买了一批具有10 <sup>17</sup> Hash/s的矿机，她希望锁定574560区块（05-04）到582624区块（06-28）近两个月的挖矿收益。于是Alice在市场上买入一组连续交割的算力收益合约空头代币，每种代币购买0.1个。以下是到期交割时Alice的盈亏情况。

头寸代币 | 到期日 | 进入价格 | 交割指数 | 头寸盈亏 | 挖矿收入 |  综合收入 
---------------| -------------|----------------|--------|-----------|-----------|-------------
BHR-450-600-574560-S | 05-04 |  75  | 525.3 | -0.03 | 52.53  | 52.50
BHR-450-600-576576-S | 05-18 |  85  | 525.0 | -1.0   | 52.50  | 51.50
BHR-450-600-578592-S | 05-31 | 100 | 471.9 | 2.81   | 47.19 | 50.00
BHR-450-600-580608-S | 06-14 | 115 | 471.1 | 1.39   | 47.11 | 48.50

### 4.3 固收投资 (Fixed-income investment)

算力收益合约剥离了挖矿中因挖矿难度变化而带来的风险，从而提出了一种固定收益的投资模式。投资人可以购买（或租赁）实体矿机并在矿场挖矿，同时进入算力收益合约空头对冲掉挖矿难度上升带来的风险。如果是法币本位投资者，还可以进入币价的空头对冲掉币价下跌的风险。通过上述方法，组合出一个无风险的固定收益投资品。无风险固收投资者提供为整个挖矿产业生态提供了资金。无风险固收投资者需要管理实体矿机矿场确保挖矿生产，提供了在虚拟挖矿衍生品和实体矿机挖矿中的桥梁作用。

### 4.4 融资租赁（Finance lease）

矿场经营者的痛点是缺乏资金，无法加杠杆扩大生产。由于挖矿的风险不可控，没有人敢给挖矿行业贷款。矿场经营者可以将矿机按时间出租给无风险固收投资者或抵押给融资租赁的资金提供方，从而获得一笔现金流用于增加杠杆扩大生产规模。当把矿机抵押给融资租赁的资金提供方时，资金提供方可以要求融资方进入算力收益合约空头和币价空头，从而增加贷款人的偿债能力。

### 4.5 云挖矿 (Cloud mining)
利用算力收益智能合约之上，可以很容易的构建一个虚拟云挖矿业务。虚拟云挖矿业务面向已经理解云挖业务的用户。

传统投资云算力是这样一个经济模型：用户在初期投入一部分资金用于购买云算力，并在之后一段连续时间内不断获得一些挖矿收益。用户希望获得挖矿的总收益最终可以大于购买云算力的投入。不考虑币价波动的情况(或者对币价做完全对冲)，云算力投入的回报只和挖矿难度相关。

可以很容易的利用算力收益智能合约模拟上述过程：用户在市场上进入一组大小相同的连续交割的算力收益合约多头，这些算力收益合约的指数下限都是0，这一过程类似于投资云算力。之后用户会不断收到头寸代币交割后返还的资金，收到资金的过程类似挖矿收益。用户购买的云算力的算力大小即是头寸大小对应的合约指数的算力大小。由于这些算力收益合约的指数下限都是0，所以多头永远没有爆仓问题，非常类似于挖矿。

### 4.6 投机 (Speculate）

算力收益合约构建了一个双边市场。在这一市场中，可以做多或做空算力收益。投资者可以出于投机目的进入合约多头，成为挖矿对冲者的对手方。只要能建立挖矿难度增长的准确估计，就可以通过为挖矿承担风险的方式投机获利。

### 4.7 为杠杆交易配资 (Margin Funding)

对于远期交割的算力收益合约，由于指数波动较大，为了防止指数触达合约上下限，往往需要设置较大范围指数上下限，这样设置合约，会使得无论合约空头代币还是多头代币都需要在Market Protocol中质押相对多的保证金，进而表现为空头和多头代币价格都很高，从而减少了资金利用率。尤其是当用于挖矿对冲的时候，投资人已经花费大量资金在购买矿机上，如果对冲远期风险还需要占用大量资金，则会大大减低投资人的对冲欲望。为此，我们也引入了浮动保证金机制（例如dydx）。

在浮动保证金机制下，出现了一种专门为杠杆交易配资以赚取无风险利息收益的业务模式。投资人在Market Protocol中创建合约代币对，但投资人不在市场上交易这些头寸代币，而是始终维持净头寸为0。配资投资人把多头代币和空头代币都出借到dydx等融资平台的资金池中。当需要浮动保证金杠杆交易的交易员从dydx中贷出多头代币或空头代币时，配资投资人可以获得利息收益。

### 4.8 做市商 (Market Maker)
任何双边市场都可以存在做市商。做市商通过为市场提供流动性并承担做市风险而获利。由于头寸代币是标准的ERC20代币，所有现有的加密货币做市商机制都可以引入进来。做市商可以通过观察订单薄进行低卖高卖的策略做市获利，也可以通过创建头寸代币对并质押到Uniswap等自动化做市合约中做市获利。


## 5. 社区介绍 (Introducation to Carboclan)

## 6. 致谢 (Acknowledgement)

